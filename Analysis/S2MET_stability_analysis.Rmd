---
title: "S2MET Stability Analysis"
output: html_notebook
bibliography: C:/Users/Jeff/Documents/Literature/library.bib
---

This notebook will outline the stability analysis of the S2MET phenotype data


## Introduction

Load packages and set directories

```{r setup}

library(tidyverse)
library(readxl)
library(lme4)
library(broom)
library(stringr)
library(FW)
library(ggridges)
library(pbr)

# Project and other directories
source("C:/Users/Jeff/Google Drive/Barley Lab/Projects/S2MET_Mapping/source.R")


# Remove the environments in which the vp was only observed
S2_MET_BLUEs_use <- S2_MET_BLUEs %>%
  group_by(trait, environment) %>%
  filter(sum(line_name %in% tp) > 1) %>%
  ungroup()

# Number of environments and entries
env <- pull(distinct(S2_MET_BLUEs_use, environment))
n_env <- n_distinct(env)
n_entries <- n_distinct(S2_MET_BLUEs_use$line_name)


```


## Finlay-Wilkinson Regression

Use the environment means to calculate the FW stability coefficient. Try both a fixed linear model and a mixed model where the regression coefficients are random effects

### Fixed Effect Model

The model for the regression coefficients looks like:

$$
y_{ij} = \mu + G_i + (1 + b_i)E_j + \epsilon_{ij},
$$

where $y_{ij}$ is the BLUE of the *i*th genotype in the *j*th environment, $\mu$ is the overall mean, $g_i$ is the effect of the *i*th genotype, $E_j$ is the mean of the *j*th environment, and $b_i$ is the regression coefficient of the response on the mean of the *j*th environment, and $\epsilon_{ij}$ is the random error.

To fit FW, we first fit a regular quantitative genetic model:

$$
y_{ij} = \mu + G_i + E_j + \epsilon_{ij}
$$

to obtain the environmental effects $E_j$. We then fit the following model for every genotype

$$
y_j = \mu + (1 + b)E_j + \epsilon_{ij}
$$

## Results

Plot the FW regression (regular version)



```{r plot.fw}

# Load fw data
load(file.path(result_dir, "S2MET_fw_regression_results.RData"))

# Plot the genotypic value by environmental mean
(g_fw_reg <- S2_MET_BLUEs_fw %>% 
  filter(stability_term == "b") %>%
  ggplot(aes(x = h, y = value, col = Program, group = line_name)) + 
  geom_point() + 
  geom_abline(aes(slope = estimate, intercept = g, col = Program), alpha = 0.15) +
  facet_wrap(stability_term ~ trait, ncol = 2, scales = "free") +
  ylab("Genotypic Mean") +
  xlab("Environmental Effect") +
  labs(
    title = "Finlay-Wilkinson Regression for All S2MET Entries"
  ) +
  # scale_color_brewer(palette = "Set2") +
  theme_bw() +
  theme(
    legend.position = c(0.75, 0.25),
    legend.background = element_rect(fill = "grey85", color = NA)
  ))

save_file <- file.path(fig_dir, "fw_plots.jpg")
ggsave(filename = save_file, plot = g_fw_reg, width = 8, height = 6)

```


Plot stability across ECs

```{r plot.fw.ec}

# Load fw data
load(file.path(result_dir, "S2MET_ec_fw_regression_results.RData"))

# Plot the genotypic value by environmental mean
(g_fw_reg_one_year <- S2_MET_BLUEs_one_year_fw %>% 
    filter(stability_term == "b") %>%
    ggplot(aes(x = h_ec, y = value, col = Program, group = line_name)) + 
    geom_point() + 
    geom_abline(aes(slope = estimate, intercept = g, col = Program), alpha = 0.15) +
    facet_grid(variable ~ trait))

save_file <- file.path(fig_dir, "fw_plots.jpg")
ggsave(filename = save_file, plot = g_fw_reg, width = 8, height = 6)

```



Extract FW stability coefficients and plot a histogram

```{r plot.b}

# Plot distrubutions for those coefficients
(g_dist_sens <- S2_MET_BLUEs_fw %>% 
   select(trait, line_name, Program, g, b, delta) %>% 
   distinct() %>% 
   gather(sens_coef, value, -trait:-g) %>%
  ggplot(aes(x = value, y = Program, fill = Program)) +
  geom_density_ridges() +
  facet_wrap(trait ~ sens_coef, scales = "free_x", ncol = 2) +
  ylab("") +
  xlab("Sensitivity Coefficient") +
  scale_fill_discrete(drop = FALSE) +
  theme_bw() +
  theme(
    axis.text.y = element_blank()
  ) +
  labs(
    title = "Distribution of Sensitivity Coefficients by Breeding Program"
  ))

save_file <- file.path(fig_dir, "dist_fw_coef.jpg")
ggsave(filename = save_file, plot = g_dist_sens, width = 6, height = 8)


```


Plot the relationship between the genotypic effect and the sensitivity

```{r plot.corr}

(g_coef_by_mean <- S2_MET_BLUEs_fw %>% 
  select(trait, line_name, g, stability_term, estimate, Program) %>% 
  filter(stability_term == "b") %>%
  group_by(trait) %>% 
  mutate(corr = cor(g, estimate, use = "complete.obs"),
         corr = str_c("r = ", round(corr, 3))) %>%
  ggplot(aes(x = g, y = estimate, col = Program, group = FALSE)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, col = "black") +
  geom_text(aes(x = Inf, y = Inf, label = corr, vjust = 1.5, hjust = 1.5), col = "black") +
  facet_wrap(~ trait, scales = "free_x", ncol = 2) +
  ylab("Sensitivity Coefficient") +
  xlab("Genotype Mean") +
  theme_bw() +
  theme(
    legend.position = c(0.75, 0.25),
    legend.background = element_rect(fill = "grey85", color = NA)
  ) +
  labs(
    title = "Relationship Between Genotype Mean and Sensitivity"
  ))

save_file <- file.path(fig_dir, "fw_coef_vs_mean.jpg")
ggsave(filename = save_file, plot = g_coef_by_mean, width = 8, height = 6)



```


What is the relationship between the genotype mean and the non-linear stability (i.e. $\delta_j$)?

```{r}

(g_delta_by_mean <- S2_MET_BLUEs_fw %>% 
  select(trait, line_name, g, delta, Program) %>% 
  distinct() %>% 
  group_by(trait) %>% 
  mutate(corr = cor(g, delta, use = "complete.obs"),
         corr = str_c("r = ", round(corr, 3))) %>%
  ggplot(aes(x = g, y = delta, col = Program, group = FALSE)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, col = "black") +
  geom_text(aes(x = Inf, y = Inf, label = corr, vjust = 1.5, hjust = 1.5), col = "black") +
  facet_wrap(~ trait, scales = "free", ncol = 2) +
  ylab("Non-Linear Sensitivity Coefficient") +
  xlab("Genotype Mean") +
  theme_bw() +
  theme(
    legend.position = c(0.75, 0.25),
    legend.background = element_rect(fill = "grey85", color = NA)
  ) +
  labs(
    title = "Relationship Between Genotype Mean and Non-Linear Sensitivity"
  ))

save_file <- file.path(fig_dir, "fw_delta_vs_mean.jpg")
ggsave(filename = save_file, plot = g_delta_by_mean, width = 8, height = 6)

```


### Independent Environmental Gradients

Visualize the distribution of environments around the environmental gradient

```{r viz.env.cov}

# Pull out the environments for which pheno data is available
one_year_env_df1 <- one_year_env_df %>%
  filter(environment %in% env)

multi_year_env_df1 <- multi_year_env_df %>%
  filter(environment %in% env)

# How many variables?
n_ecs <- n_distinct(one_year_env_df1$variable)

# Plot
one_year_env_df1 %>%
  ggplot(aes(x = value, y = 0, col = environment)) +
  geom_point() +
  scale_color_discrete(guide = FALSE) +
  facet_wrap("variable", scales = "free_x")


```


Fit a regression model to find significant environmental covariates. The model will use the environmental effect (calculated from BLUEs) as the response, such that:

$$
h_j = \beta_0 + x_1\beta_1 + x_2\beta_2 + ... + x_p\beta_p
$$

where $h_j$ is the effect of the *j*th environment, $\beta_0$ is the intercept, and $1, 2, ..., p$ signify the specific environment covariate

```{r stepwise.lm.ec}

# Filter out the 'monthly' variables
one_year_env_df_filt <- one_year_env_df %>%
  filter(!str_detect(variable, "^month"))

multi_year_env_df_filt <- multi_year_env_df %>%
  filter(!str_detect(variable, "^month"))

S2_MET_BLUEs_one_year <- S2_MET_BLUEs_fw %>% 
  distinct(environment, trait, h) %>%
  left_join(., one_year_env_df_filt) %>%
  spread(variable, value) %>%
  select(-environment) %>%
  group_by(trait) %>%
  nest()

# Fit the full model
S2_MET_BLUEs_one_year_fit <- S2_MET_BLUEs_one_year %>%
  group_by(trait) %>%
  do(fit = {
    df <- unnest(., data)
    lm(h ~ ., data = select(df, -trait)) })

# Stepwise regression
S2_MET_BLUEs_one_year_step <- S2_MET_BLUEs_one_year_fit %>% 
  ungroup() %>% 
  mutate(step_fit = map(fit, step, direction = "backward", trace = 0)) %>%
  mutate(terms_to_keep = map(step_fit, terms), 
         terms_to_keep = map(terms_to_keep, attr, "term.labels"))

# Extract the usable terms
S2_MET_BLUEs_one_year_terms <- S2_MET_BLUEs_one_year_step %>% 
  unnest(terms_to_keep)

  



```




