---
title: "S2MET Stability Analysis"
output: html_notebook
bibliography: C:/Users/Jeff/Documents/Literature/library.bib
---

This notebook will outline the stability analysis of the S2MET phenotype data


## Introduction

Load packages and set directories

```{r setup}

library(tidyverse)
library(readxl)
library(lme4)
library(broom)
library(stringr)
library(FW)

# Project and other directories
source("C:/Users/Jeff/Google Drive/Barley Lab/Projects/S2MET_Mapping/source.R")

```


## Finlay-Wilkinson Regression

Use the environment means to calculate the FW stability coefficient. Try both a fixed linear model and a mixed model where the regression coefficients are random effects

### Fixed Effect Model

The model for the regression coefficients looks like:

$$
y_{ij} = \mu + g_i + b_ih_j + \epsilon_{ij},
$$

where $y_{ij}$ is the BLUE of the *i*th genotype in the *j*th environment, $\mu$ is the overall mean, $g_i$ is the effect of the *i*th genotype, $h_j$ is the mean of the *j*th environment, and $b_i$ is the regression coefficient of the response on the mean of the *j*th environment, and $\epsilon_{ij}$ is the random error.

Fit the model

```{r fw.fixed}

# Remove the environments in which the vp was only observed
S2_MET_BLUEs_use <- S2_MET_BLUEs %>%
  group_by(trait, environment) %>%
  filter(sum(line_name %in% tp) > 1)

# Number of environments and entries
n_env <- n_distinct(S2_MET_BLUEs_use$environment)
n_entries <- n_distinct(S2_MET_BLUEs_use$line_name)


# Group by trait and fit the model
fw_fit <- S2_MET_BLUEs_use %>% 
  group_by(trait) %>%
  do(fw_fit = FW(y = .$value, VAR = .$line_name, ENV = .$environment, method = "OLS"))

# Extract the sensitivity coefficients
fw_coef <- fw_fit %>%
  mutate(fw_g = list({
    fw_fit$g %>% 
      as.data.frame() %>%
      rownames_to_column("line_name") %>%
      rename(g = V1) })) %>%
  mutate(fw_b = list({
    fw_fit$b %>% 
      as.data.frame() %>%
      rownames_to_column("line_name") %>%
      rename(b = V1) })) %>%
  mutate(fw_h = list({
    fw_fit$h %>% 
      as.data.frame() %>%
      rownames_to_column("environment") %>%
      rename(h = V1) }))  

# Unnest the g and b coefficients
fw_line_coefs <- fw_coef %>% 
  unnest(fw_g, fw_b) %>% 
  select(-line_name1) %>% 
  mutate(b = b + 1)

fw_env_coef <- fw_coef %>%
  unnest(fw_h)

# Color by entry subpopulation (i.e. program)
S2_MET_BLUEs_use_entries <- left_join(S2_MET_BLUEs_use, select(entry_list, Line, Program), 
                                      by = c("line_name" = "Line"))

# Levels of breeding program
program_levels <- sort(unique(S2_MET_BLUEs_use_entries$Program))

# Add the regression coefficients
S2_MET_BLUEs_fw <- S2_MET_BLUEs_use_entries %>% 
  left_join(., fw_line_coefs, by = c("trait", "line_name")) %>% 
  left_join(., fw_env_coef, by = c("trait", "environment")) %>%
  ungroup() %>%
  mutate(Program = parse_factor(Program, levels = program_levels))

# Save this
save_file <- file.path(result_dir, "S2MET_fw_regression_results.RData")
save("S2_MET_BLUEs_fw", file = save_file)

```


Plot the FW regression

```{r plot.fw}

# Load fw data
load(file.path(result_dir, "S2MET_fw_regression_results.RData"))

# Plot the genotypic value by environmental mean
(g_fw_reg <- S2_MET_BLUEs_fw %>% 
  ggplot(aes(x = h, y = value, col = Program, group = line_name)) + 
  geom_point() + 
  geom_abline(aes(slope = b, intercept = g, col = Program), alpha = 0.15) +
  facet_wrap(~ trait, ncol = 2, scales = "free") +
  ylab("Genotypic Mean") +
  xlab("Environmental Effect") +
  labs(
    title = "Finlay-Wilkinson Regression for All S2MET Entries"
  ) +
  # scale_color_brewer(palette = "Set2") +
  theme_bw() +
  theme(
    legend.position = c(0.75, 0.25),
    legend.background = element_rect(fill = "grey85", color = NA)
  ))

save_file <- file.path(fig_dir, "fw_plots.jpg")
ggsave(filename = save_file, plot = g_fw_reg, width = 8, height = 6)

```


Extract FW stability coefficients and plot a histogram

```{r plot.b}

# Plot distrubutions for those coefficients
(g_dist_b <- S2_MET_BLUEs_fw %>% 
  select(trait, line_name, g, b, Program) %>% 
  distinct() %>%
  ggplot(aes(x = b, y = Program, fill = Program)) +
  geom_density_ridges() +
  facet_grid(trait ~ .) +
  ylab("") +
  xlab("Sensitivity Coefficient") +
  scale_fill_discrete(drop = FALSE) +
  theme_bw() +
  theme(
    axis.text.y = element_blank()
  ) +
  labs(
    title = "Distribution of Sensitivity Coefficients by Breeding Program"
  ))

save_file <- file.path(fig_dir, "dist_fw_coef.jpg")
ggsave(filename = save_file, plot = g_dist_b, width = 6, height = 8)


```


Plot the relationship between the genotypic effect and the sensitivity

```{r plot.corr}

# Plot the correlation between the intercept (genotypic mean overall) and the slope
(g_coef_by_mean <- S2_MET_BLUEs_fw %>% 
  select(trait, line_name, g, b, Program) %>% 
  distinct() %>% 
  group_by(trait) %>% 
  mutate(corr = cor(g, b, use = "complete.obs"),
         corr = str_c("r = ", round(corr, 3))) %>%
  ggplot(aes(x = g, y = b, col = Program, group = FALSE)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, col = "black") +
  geom_text(aes(x = Inf, y = Inf, label = corr, vjust = 1.5, hjust = 1.5), col = "black") +
  facet_wrap(~ trait, scales = "free_x", ncol = 2) +
  ylab("Sensitivity Coefficient") +
  xlab("Genotype Mean") +
  theme_bw() +
  theme(
    legend.position = c(0.75, 0.25),
    legend.background = element_rect(fill = "grey85", color = NA)
  ) +
  labs(
    title = "Relationship Between Genotype Mean and Sensitivity"
  ))

save_file <- file.path(fig_dir, "fw_coef_vs_mean.jpg")
ggsave(filename = save_file, plot = g_coef_by_mean, width = 8, height = 6)



```







