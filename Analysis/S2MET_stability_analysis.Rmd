---
title: "S2MET Stability Analysis"
output: html_notebook
bibliography: C:/Users/Jeff/Documents/Literature/library.bib
---

This notebook will outline the stability analysis of the S2MET phenotype data


## Introduction

Load packages and set directories

```{r setup}

library(tidyverse)
library(readxl)
library(lme4)
library(broom)
library(stringr)
library(FW)
library(ggridges)
library(ggforce)
library(pbr)

# Project and other directories
source("C:/Users/Jeff/Google Drive/Barley Lab/Projects/S2MET_Mapping/source.R")


# Remove the environments in which the vp was only observed
S2_MET_BLUEs_use <- S2_MET_BLUEs %>%
  group_by(trait, environment) %>%
  filter(sum(line_name %in% tp) > 1) %>%
  ungroup()

# Number of environments and entries
env <- pull(distinct(S2_MET_BLUEs_use, environment))
n_env <- n_distinct(env)
n_entries <- n_distinct(S2_MET_BLUEs_use$line_name)


```


## Finlay-Wilkinson Regression

Use the environment means to calculate the FW stability coefficient. Try both a fixed linear model and a mixed model where the regression coefficients are random effects

### Fixed Effect Model

The model for the regression coefficients looks like:

$$
y_{ij} = \mu + G_i + (1 + b_i)E_j + \epsilon_{ij},
$$

where $y_{ij}$ is the BLUE of the *i*th genotype in the *j*th environment, $\mu$ is the overall mean, $g_i$ is the effect of the *i*th genotype, $E_j$ is the mean of the *j*th environment, and $b_i$ is the regression coefficient of the response on the mean of the *j*th environment, and $\epsilon_{ij}$ is the random error.

To fit FW, we first fit a regular quantitative genetic model:

$$
y_{ij} = \mu + G_i + E_j + \epsilon_{ij}
$$

to obtain the environmental effects $E_j$. We then fit the following model for every genotype

$$
y_j = \mu + (1 + b)E_j + \epsilon_{ij}
$$

## Results

### Summary

What is the range in environmental effects per trait?

```{r env.range}

# Load fw data
load(file.path(result_dir, "S2MET_pheno_fw_regression_results.RData"))

# Combine df and mark the population
S2_MET_pheno_fw_comb <- S2_MET_pheno_fw %>%
  list(., names(.)) %>% 
  pmap_df(~mutate(.x, population = .y)) %>%
  mutate(program = as.factor(program))

S2_MET_pheno_fw_comb %>%
  filter(population == "pop_all") %>%
  group_by(trait) %>% summarize_at(vars(h), funs(min, max)) %>% 
  mutate(range = max - min) %>% 
  select(trait, range)

S2_MET_pheno_fw_comb %>%
  filter(population == "pop_tp") %>%
  group_by(trait) %>% summarize_at(vars(h), funs(min, max)) %>% 
  mutate(range = max - min) %>% 
  select(trait, range)


```



### Normal FW Regression

Plot the FW regression (regular version)

This is typical FW regression (i.e. using the phenotypic means)

```{r plot.fw}


# Plot both the TP and VP
g_pheno_fw_all <- S2_MET_pheno_fw_comb %>%
  filter(stability_term == "b") %>%
  ggplot(aes(x = h, y = value, col = program, group = line_name)) + 
  geom_point() + 
  geom_abline(aes(slope = estimate, intercept = g, col = program), alpha = 0.15) +
  facet_wrap(trait ~ population, ncol = 2, scales = "free") +
  ylab("Genotypic Mean") +
  xlab("Environmental Effect") +
  labs(
    title = "Finlay-Wilkinson Regression"
  ) +
  # scale_color_brewer(palette = "Set2") +
  theme_bw() +
  theme(legend.background = element_rect(fill = "grey85", color = NA))

# Plot just the TP
g_pheno_fw_tp <- S2_MET_pheno_fw_comb %>%
  filter(stability_term == "b", population == "pop_tp") %>%
  ggplot(aes(x = h, y = value, col = program, group = line_name)) + 
  geom_point() + 
  geom_abline(aes(slope = estimate, intercept = g, col = program), alpha = 0.15) +
  facet_wrap(~ trait, ncol = 2, scales = "free") +
  scale_color_discrete(drop = FALSE) +
  ylab("Genotypic Mean") +
  xlab("Environmental Effect") +
  labs(
    title = "Finlay-Wilkinson Regression"
  ) +
  # scale_color_brewer(palette = "Set2") +
  theme_bw() +
  theme(
    legend.position = c(0.75, 0.25),
    legend.background = element_rect(fill = "grey85", color = NA)
  )

save_file <- file.path(fig_dir, "pheno_fw_all.jpg")
ggsave(filename = save_file, plot = g_pheno_fw_all, width = 8, height = 6)

save_file <- file.path(fig_dir, "pheno_fw_tp.jpg")
ggsave(filename = save_file, plot = g_pheno_fw_tp, width = 8, height = 6)


## Subset genotypes to highlight different responses
pheno_fw_example <- S2_MET_pheno_fw_comb %>%
  filter(stability_term == "b", population == "pop_tp") %>% 
  select(trait, line_name, g, estimate) %>% 
  distinct() %>% 
  group_by(trait) %>% 
  filter(estimate == min(estimate) | estimate == max(estimate) | abs(1 - estimate) == min(abs(1 - estimate)))

g_pheno_fw_tp_example <- S2_MET_pheno_fw_comb %>%
  filter(stability_term == "b", population == "pop_tp") %>% 
  select(trait, environment, line_name, value, h) %>% 
  ggplot(aes(x = h, y = value)) + 
  geom_point() + 
  geom_abline(data = pheno_fw_example, aes(intercept = g, slope = estimate, col = line_name), lwd = 1) + 
  scale_color_discrete(guide = guide_legend(title = "Line Name", ncol = 2)) +
  facet_wrap(~ trait, ncol = 2, scales = "free") +
  ylab("Genotype Mean") +
  xlab("Environment Effect") +
  labs(title = "Range of Environemntal Effects and Example Line Responses") +
  theme_bw() +
  theme(legend.position = c(0.75, 0.25),
        legend.background = element_rect(fill = "grey85", color = NA) )

save_file <- file.path(fig_dir, "pheno_fw_tp_example.jpg")
ggsave(filename = save_file, plot = g_pheno_fw_tp_example, width = 8, height = 6)



```


Plot a histogram of FW stability coefficients

```{r plot.b}

# Plot distrubutions of the stability coefficients

g_stability_dist_all <- S2_MET_pheno_fw_comb %>% 
  filter(population == "pop_all") %>%
  select(trait, line_name, program, stability_term, estimate, population) %>%
  distinct() %>% 
  ggplot(aes(x = estimate, y = program, fill = program)) +
  geom_density_ridges() +
  facet_wrap(trait ~ stability_term, scales = "free_x", ncol = 2) +
  ylab("") +
  xlab("Sensitivity Coefficient") +
  scale_fill_discrete(drop = FALSE) +
  theme_bw() +
  theme(axis.text.y = element_blank()) +
  labs(title = "Distribution of Sensitivity Coefficients by Breeding Program",
       caption = "The program 'BA' contains one line.")

## Plot just the TP
g_stability_dist_tp <- S2_MET_pheno_fw_comb %>% 
  filter(population == "pop_tp") %>%
  select(trait, line_name, program, stability_term, estimate, population) %>%
  distinct() %>% 
  ggplot(aes(x = estimate, y = program, fill = program)) +
  geom_density_ridges() + facet_wrap(trait ~ stability_term, scales = "free_x", ncol = 2) +
  ylab("") +
  xlab("Sensitivity Coefficient") +
  scale_fill_discrete(drop = FALSE) +
  theme_bw() +
  theme(axis.text.y = element_blank()) +
  labs(title = "Distribution of Sensitivity Coefficients by Breeding Program",
       caption = "The program 'BA' contains one line.")

## Plot the slope and MSE measures separately to standardize the scale
g_stability_b_dist_tp <- S2_MET_pheno_fw_comb %>% 
  filter(population == "pop_tp", stability_term == "b") %>%
  select(trait, line_name, program, stability_term, estimate, population) %>%
  distinct() %>% 
  ggplot(aes(x = estimate, y = program, fill = program)) +
  geom_density_ridges() + facet_wrap(~ trait, ncol = 1) +
  ylab("") +
  xlab("Sensitivity Coefficient") +
  scale_fill_discrete(drop = FALSE) +
  theme_bw() +
  theme(axis.text.y = element_blank()) +
  labs(title = "Distribution of Sensitivity Coefficients by Breeding Program",
       caption = "The program 'BA' contains one line.")



save_file <- file.path(fig_dir, "pheno_fw_dist_all.jpg")
ggsave(filename = save_file, plot = g_stability_dist_all, width = 6, height = 8)

save_file <- file.path(fig_dir, "pheno_fw_dist_tp.jpg")
ggsave(filename = save_file, plot = g_stability_dist_tp, width = 6, height = 8)

save_file <- file.path(fig_dir, "pheno_fw_dist_b_tp.jpg")
ggsave(filename = save_file, plot = g_stability_b_dist_tp, width = 6, height = 8)

```


Plot the relationship between the genotypic effect and the sensitivity

```{r plot.corr}

g_stability_and_mean <- S2_MET_pheno_fw_comb %>% 
  select(trait, line_name, g, stability_term, estimate, program, population) %>% 
  distinct() %>%
  filter(stability_term == "b") %>%
  group_by(trait, population) %>% 
  mutate(corr = cor(g, estimate, use = "complete.obs"),
         corr = str_c("r = ", round(corr, 3))) %>%
  ggplot(aes(x = g, y = estimate, col = program, group = FALSE)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, col = "black") +
  geom_text(aes(x = Inf, y = -Inf, label = corr, vjust = -1, hjust = 1), col = "black") +
  facet_wrap(trait ~ population, scales = "free_x", ncol = 2) +
  ylab("Sensitivity Coefficient") +
  xlab("Genotype Mean") +
  theme_bw() +
  theme(legend.background = element_rect(fill = "grey85", color = NA)) +
  labs(title = "Relationship Between Genotype Mean and Sensitivity" )

save_file <- file.path(fig_dir, "pheno_fw_stability_mean.jpg")
ggsave(filename = save_file, plot = g_stability_and_mean, width = 6, height = 8)


# Plot just for TP
g_stability_and_mean_Tp <- S2_MET_pheno_fw_comb %>% 
  filter(population == "pop_tp") %>%
  select(trait, line_name, g, stability_term, estimate, program, population) %>% 
  distinct() %>%
  filter(stability_term == "b") %>%
  group_by(trait, population) %>% 
  mutate(corr = cor(g, estimate, use = "complete.obs"),
         corr = str_c("r = ", round(corr, 3))) %>%
  ggplot(aes(x = g, y = estimate, col = program, group = FALSE)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, col = "black") +
  geom_text(aes(x = Inf, y = -Inf, label = corr, vjust = -1, hjust = 1), col = "black") +
  facet_wrap(~ trait, scales = "free_x", ncol = 2) +
  ylab("Sensitivity Coefficient") +
  xlab("Genotype Mean") +
  labs(title = "Relationship Between Genotype Mean and Sensitivity" ) +
  theme_bw() +
  theme(legend.background = element_rect(fill = "grey85", color = NA),
        legend.position = c(0.75, 0.25))
  

save_file <- file.path(fig_dir, "pheno_fw_stability_mean_tp.jpg")
ggsave(filename = save_file, plot = g_stability_and_mean_Tp, width = 6, height = 6)



```


### Environmental Covariate Sensitivity


Plot stability across ECs

```{r plot.fw.ec}

# Load fw data
load(file.path(result_dir, "S2MET_ec_fw_regression_results.RData"))

# Combine the populations into one df
S2_MET_ec_oneyear_fw_comb <- S2_MET_ec_oneyear_fw %>% 
  list(., names(.)) %>% 
  pmap_df(~mutate(.x, population = .y))

S2_MET_ec_multiyear_fw_Comb <- S2_MET_ec_multiyear_fw %>% 
  list(., names(.)) %>% 
  pmap_df(~mutate(.x, population = .y))

## Plot the value of each genotype in each environment over the environmental
## gradient based on ECs
g_ec_oneyear_fw_tp <- S2_MET_ec_oneyear_fw_comb %>% 
  filter(stability_term == "b", population == "pop_tp") %>%
  ggplot(aes(x = h_ec, y = value, col = program, group = line_name)) + 
  geom_point() + 
  geom_abline(aes(slope = estimate, intercept = g, col = program), alpha = 0.15) +
  facet_grid_paginate(trait ~ variable, nrow = 3, ncol = 5, page = 1, scales = "free") +
  theme_bw()

## Iterate through the pages and save the graphs
for (i in seq(n_pages(g_ec_oneyear_fw_tp))) {
  save_file <- file.path(fig_dir, str_c("oneyear_ec_fw_tp", i, ".jpg"))
  g <- g_ec_oneyear_fw_tp + facet_grid_paginate(trait ~ variable, nrow = 3, ncol = 5, page = i, scales = "free")
  ggsave(filename = save_file, plot = g, width = 9, height = 7)
}


# Plot using all data
g_ec_oneyear_fw_all <- S2_MET_ec_oneyear_fw_comb %>% 
  filter(stability_term == "b", population == "pop_all") %>%
  ggplot(aes(x = h_ec, y = value, col = program, group = line_name)) + 
  geom_point() + 
  geom_abline(aes(slope = estimate, intercept = g, col = program), alpha = 0.15) +
  facet_grid_paginate(trait ~ variable, nrow = 3, ncol = 5, page = 1, scales = "free") +
  theme_bw()

## Iterate through the pages and save the graphs
for (i in seq(n_pages(g_ec_oneyear_fw_all))) {
  save_file <- file.path(fig_dir, str_c("oneyear_ec_fw_all", i, ".jpg"))
  g <- g_ec_oneyear_fw_all + facet_grid_paginate(trait ~ variable, nrow = 3, ncol = 5, page = i, scales = "free")
  ggsave(filename = save_file, plot = g, width = 9, height = 7)
}





## Multi-year ECs
g_ec_multiyear_fw_tp <- S2_MET_ec_multiyear_fw_Comb %>% 
  filter(stability_term == "b", population == "pop_tp") %>%
  ggplot(aes(x = h_ec, y = value, col = program, group = line_name)) + 
  geom_point() + 
  geom_abline(aes(slope = estimate, intercept = g, col = program), alpha = 0.15) +
  facet_grid_paginate(trait ~ variable, nrow = 3, ncol = 5, page = 1, scales = "free") +
  theme_bw()

## Iterate through the pages and save the graphs
for (i in seq(n_pages(g_ec_multiyear_fw_tp))) {
  save_file <- file.path(fig_dir, str_c("multiyear_ec_fw_tp", i, ".jpg"))
  g <- g_ec_multiyear_fw_tp + facet_grid_paginate(trait ~ variable, nrow = 3, ncol = 5, page = i, scales = "free")
  ggsave(filename = save_file, plot = g, width = 9, height = 7)
}


# Plot using all data
g_ec_multiyear_fw_all <- S2_MET_ec_multiyear_fw_Comb %>% 
  filter(stability_term == "b", population == "pop_all") %>%
  ggplot(aes(x = h_ec, y = value, col = program, group = line_name)) + 
  geom_point() + 
  geom_abline(aes(slope = estimate, intercept = g, col = program), alpha = 0.15) +
  facet_grid_paginate(trait ~ variable, nrow = 3, ncol = 5, page = 1, scales = "free") +
  theme_bw()

## Iterate through the pages and save the graphs
for (i in seq(n_pages(g_ec_multiyear_fw_all))) {
  save_file <- file.path(fig_dir, str_c("multiyear_ec_fw_all", i, ".jpg"))
  g <- g_ec_multiyear_fw_all + facet_grid_paginate(trait ~ variable, nrow = 3, ncol = 5, page = i, scales = "free")
  ggsave(filename = save_file, plot = g, width = 9, height = 7)
}



```








Fit a regression model to find significant environmental covariates. The model will use the environmental effect (calculated from BLUEs) as the response, such that:

$$
h_j = \beta_0 + x_1\beta_1 + x_2\beta_2 + ... + x_p\beta_p
$$

where $h_j$ is the effect of the *j*th environment, $\beta_0$ is the intercept, and $1, 2, ..., p$ signify the specific environment covariate

```{r stepwise.lm.ec}

# Filter out the 'monthly' variables
one_year_env_df_filt <- one_year_env_df %>%
  filter(!str_detect(variable, "^month"))

multi_year_env_df_filt <- multi_year_env_df %>%
  filter(!str_detect(variable, "^month"))

S2_MET_BLUEs_one_year <- S2_MET_BLUEs_fw %>% 
  distinct(environment, trait, h) %>%
  left_join(., one_year_env_df_filt) %>%
  spread(variable, value) %>%
  select(-environment) %>%
  group_by(trait) %>%
  nest()

# Fit the full model
S2_MET_BLUEs_one_year_fit <- S2_MET_BLUEs_one_year %>%
  group_by(trait) %>%
  do(fit = {
    df <- unnest(., data)
    lm(h ~ ., data = select(df, -trait)) })

# Stepwise regression
S2_MET_BLUEs_one_year_step <- S2_MET_BLUEs_one_year_fit %>% 
  ungroup() %>% 
  mutate(step_fit = map(fit, step, direction = "backward", trace = 0)) %>%
  mutate(terms_to_keep = map(step_fit, terms), 
         terms_to_keep = map(terms_to_keep, attr, "term.labels"))

# Extract the usable terms
S2_MET_BLUEs_one_year_terms <- S2_MET_BLUEs_one_year_step %>% 
  unnest(terms_to_keep)

  



```




