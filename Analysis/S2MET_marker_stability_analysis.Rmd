---
title: "S2 MET Marker Stability Analysis"
output: html_notebook
bibliography: C:/Users/Jeff/Documents/Literature/library.bib
---

This notebook will outline the analysis of GWAS mapping procedures using the S2MET data.


## Introduction

Load packages and set directories

```{r setup}

library(tidyverse)
library(stringr)
library(readxl)
library(rrBLUP)
library(GGally)
library(IRanges)
library(qvalue)

# Project and other directories
source("C:/Users/Jeff/Google Drive/Barley Lab/Projects/S2MET_Mapping/source.R")

# Load the marker effect FW results
load(file.path(result_dir, "S2MET_pheno_mar_eff_fw_results.RData"))

tp_geno <- tp_geno_multi

# Filter the BLUEs to use
S2_MET_BLUEs_use <- S2_MET_BLUEs %>% 
  filter(line_name %in% c(tp_geno)) %>%
  droplevels()

M <- S2TP_imputed_multi_genos_mat[tp_geno,]



```


## Results

First group markers into those that are highly stable, highly sensitive, or neither

```{r grp.mars}

# Get the distinct observations of the stability measures
S2_MET_marker_eff_pheno_fw_uniq <- S2_MET_marker_eff_pheno_fw %>% 
  select(trait, marker:pos, b_std_error, df, stability_term, estimate) %>% 
  distinct()

# What should be the significance level
alpha <- 0.05

# For each trait, calculate empirical thresholds for significance
S2_MET_marker_eff_pheno_fw_sig <- S2_MET_marker_eff_pheno_fw_uniq %>%
  filter(stability_term == "b") %>% 
  group_by(trait) %>% 
  # mutate(estimate = scale(estimate)) %>%
  mutate(lower_perc = quantile(estimate, alpha / 2), 
         upper_perc = quantile(estimate, 1 - (alpha / 2))) %>%
  ungroup() %>%
  mutate(significance = case_when(estimate >= upper_perc ~ "sensitive",
                                  estimate <= lower_perc ~ "stable",
                                  TRUE ~ "not_significant"),
         marker_type = if_else(str_detect(marker, "^S"), "GBS", "BOPA"))

# Calculate a table of GBS markers and sensitive/stable/notsignificant
mar_stab_table <- S2_MET_marker_eff_pheno_fw_sig %>% 
  group_by(trait, marker_type, significance) %>% 
  summarize(n = n()) %>% 
  mutate(prop = n / sum(n))

mar_stab_table %>% 
  select(-n) %>% 
  spread(significance, prop)

```


Determine the proportion of GxE variance ($V_{GE}$) that is explained by sensitive/stable markers vs not signficant markers

The mixed-model looks like:

$$
y_{ij} = \mu + g_i + t_j + (g_st)_{ij} + (g_{ns}t)_{ij} + \epsilon_{ij},
$$

where $g_i \sim N(0, \mathbf{K}\sigma^2_g)$, $(g_st)_{ij} \sim N(0, \mathbf{K_s}\sigma^2_{g_st})$, and $(g_{ns}t)_{ij} \sim N(0, \mathbf{K_{ns}}\sigma^2_{g_{ns}t})$. $\mathbf{K}$ is the kinship matrix calculated using all markers, $\mathbf{K_s}$ is the kinship matrix calculated using only stable/sensitive markers, and $\mathbf{K_{ns}}$ is the kinship matrix calculated using only non-signficiant markers

```{r prop.gxe1}



```


Determine the proportion of genetic variance of phenotypic stability ($V_G$) that is explained by sensitive/stable markers










