---
title: "S2 MET GWAS Simulation Analysis"
output: html_notebook
bibliography: C:/Users/Jeff/Documents/Literature/library.bib
---

## Introduction

This notebook will provide some code to analyze the results of the GWAS simulation in the context of detecting QxE.

Set up directories and load packages

```{r setup}

library(tidyverse)
library(readxl)
library(gtable)
library(grid)

# Project and other directories
source("C:/Users/Jeff/Google Drive/Barley Lab/Projects/S2MET_Mapping/source.R")

# List result files
result_files <- list.files(result_dir, full.names = TRUE, pattern = "simulation")

result_list <- result_files %>%
  map(function(f) {load(f); return(sim_results)})

# Bind rows
sim_result_df <- map(result_list, bind_rows) %>% 
  list(., seq(length(.))) %>% 
  pmap(~mutate(.x, iter = (1000 * .y) + iter)) %>% 
  bind_rows()

# Alpha level for confidence intervals
alpha <- 0.05

```

## Methods

The simulation looked at different genetic architectures and population sizes for the ability to detect QTL using an association mapping approach. The simulation compared a number of models. Originally, the number of replications was 25, however this would be increased in the actual analysis


## Results

Summarize the results

```{r load.result}

# Unnest the marker assocation and qtl discovery results
sim_result_df1 <- sim_result_df %>% 
  mutate(marker_association = map(data, "assoc_count"), 
         qtl_discovery = map(data, "discovered_count")) %>%
  select(-data) %>% 
  gather(datatype, data, -iter:-core) %>%
  unnest() %>%
  mutate(model = parse_factor(model, levels = c("G", "K", "GE", "KE", "GGE", "KKE")))


## Summarize the marker association results
mar_assoc_result <- sim_result_df1 %>% 
  filter(datatype == "marker_association") %>% 
  complete(n_qtl, h2, n_pop, iter, model, sig_level, term, true_false, neg_pos, fill = list(n = 0)) %>%
  select(-datatype, -core, -n_discovered)

## Summarize qtl discovery results
qtl_disc_result <- sim_result_df1 %>% 
  filter(datatype == "qtl_discovery") %>%
  complete(n_qtl, h2, n_pop, iter, model, sig_level, term, fill = list(n = 0, n_discovered = 0)) %>%
  select(-datatype, -core) %>%
  # Edit the significance level factors
  mutate(sig_level = str_replace(sig_level, "_sig", ""))
  
# Define a summary function for dplyr
exp_summ <- funs(mean = mean(.), ci_lower = quantile(., alpha / 2), 
                             ci_upper = quantile(., 1 - (alpha / 2)))


## Summarize number of significant markers
sig_mar_summ <- mar_assoc_result %>% 
  filter(neg_pos == "positive") %>% 
  group_by_at(vars(n_qtl:term)) %>% 
  summarize(sig_mar = sum(n, na.rm = T)) %>% 
  group_by(n_qtl, h2, n_pop, model, sig_level, term) %>% 
  summarize_at(vars(sig_mar), funs(mean, sd)) %>%
  ungroup()

## Number of false positives
false_pos_summ <- mar_assoc_result %>% 
  filter(neg_pos == "positive", true_false == "false") %>% 
  group_by(n_qtl, h2, n_pop, model, sig_level, term) %>% 
  summarize_at(vars(n), funs(mean, sd), na.rm = TRUE) %>%
  ungroup()

## False discovery rate (i.e. ratio of false positives to total positives)
## and power (i.e. 1 - fdr)
power_fdr_summ <- mar_assoc_result %>% 
  filter(neg_pos == "positive") %>% 
  spread(true_false, n) %>% 
  mutate(fdr = false / (false + true), power = 1 - fdr) %>% 
  group_by(n_qtl, h2, n_pop, model, sig_level, term) %>% 
  summarize_at(vars(fdr, power), funs(mean, sd), na.rm = TRUE) %>%
  ungroup()


## Number of true QTL discovered / proportion of QTL discovered
qtl_disc_summ <- qtl_disc_result %>% 
  mutate(prop_discovered = ifelse(term == "main_effect", n_discovered / n_qtl, n_discovered / (n_qtl * 0.5))) %>%
  group_by(n_qtl, h2, n_pop, model, sig_level, term) %>% 
  summarize_at(vars(n_discovered, prop_discovered), funs(mean, sd), na.rm = TRUE) %>%
  ungroup()


## Number of true QTL per FALSE discovery
qtl_disc_fdr_summ <- full_join(select(qtl_disc_result, -true_false:-n),
                               filter(mar_assoc_result, true_false == "false", neg_pos == "positive")) %>%
  mutate(disc_per_false = n_discovered / n,
         prop_disc_per_false = ifelse(term == "main_effect", disc_per_false / n_qtl, disc_per_false / (0.5 * n_qtl))) %>%
  group_by(n_qtl, h2, n_pop, model, sig_level, term) %>% 
  summarize_at(vars(disc_per_false, prop_disc_per_false), funs(mean, sd), na.rm = TRUE) %>%
  ungroup()





```


Plot the number of significant markers

```{r sig.mar.plot}

# ggplot modifier
g_mod <- list(
  geom_col(position = "dodge"),
  geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd),
                position = position_dodge(0.9), width = 0.5),
  facet_grid(n_qtl + h2 ~ sig_level),
  ylab("Number of Significant Markers"),
  xlab("Population Size"),
  theme_bw())

## Plot the number of significant markers per model
(g_sig_mar_main <- sig_mar_summ %>% 
  filter(term == "main_effect") %>%
  mutate(n_pop = as.factor(n_pop)) %>% 
  ggplot(aes(x = n_pop, y = mean, fill = model, group = model)) + 
  labs(title = "Number of Significant Markers for Main Effect QTL") + 
  g_mod)

(g_sig_mar_qxe <- sig_mar_summ %>% 
  filter(term == "qxe") %>% 
  mutate(n_pop = as.factor(n_pop)) %>% 
  ggplot(aes(x = n_pop, y = mean, fill = model, group = model)) + 
  labs(title = "Number of Significant Markers for Interaction QTL") + 
  g_mod)

# Save
save_file <- file.path(fig_dir, "simulation_sig_mar_main.jpg")
ggsave(filename = save_file, plot = g_sig_mar_main, width = 6, height = 6)

save_file <- file.path(fig_dir, "simulation_sig_mar_qxe.jpg")
ggsave(filename = save_file, plot = g_sig_mar_qxe, width = 6, height = 6)


## Reduce to the fdr = 0.05 level and the pairs (h2 = 0.8 & n_qtl = 30 and h2 = 0.5 & n_qtl = 100)
exp <- expression((sig_level == "fdr0.05") & ( (n_qtl == 30 & h2 == 0.5) | (n_qtl == 100 & h2 == 0.8) ))

g_sig_mar <- sig_mar_summ %>% 
  filter(eval(exp)) %>%
  mutate(n_pop = as.factor(n_pop)) %>% 
  ggplot(aes(x = n_pop, y = mean, fill = model, group = model)) + 
  labs(title = "Number of Significant Markers") + 
  geom_col(position = "dodge") +
  geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd),
                position = position_dodge(0.9), width = 0.5) +
  facet_grid(n_qtl + h2 ~ term) +
  ylab("Number of Significant Markers") +
  xlab("Population Size") +
  theme_bw()

save_file <- file.path(fig_dir, "simulation_sig_mar.jpg")
ggsave(filename = save_file, plot = g_sig_mar, width = 6, height = 6)


```


Plot the false positives

```{r false.pos.plot}

## Define a plot modifier that is common to all plots
g_mod <- list(
  geom_col(position = "dodge"),
  geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd),
                position = position_dodge(0.9), width = 0.5),
  facet_grid(n_qtl + h2 ~ sig_level),
  ylab("Number of False Positives"),
  xlab("Population Size"),
  theme_bw())


## Plot the number of false positives per model
(g_false_pos_main <- false_pos_summ %>% 
  filter(term == "main_effect") %>% 
  mutate(n_pop = as.factor(n_pop)) %>% 
  ggplot(aes(x = n_pop, y = mean, fill = model, group = model)) + 
  labs(title = "Number of False Positives for Main Effect QTL") + 
  g_mod)

(g_false_pos_qxe <- false_pos_summ %>% 
  filter(term == "qxe") %>% 
  mutate(n_pop = as.factor(n_pop)) %>% 
  ggplot(aes(x = n_pop, y = mean, fill = model, group = model)) + 
  labs(title = "Number of False Positives for Interaction QTL") +
  g_mod)


# New modifier
g_mod <- list(
  geom_col(position = "dodge"),
  geom_errorbar(aes(ymin = fdr_mean - fdr_sd, ymax = fdr_mean + fdr_sd), 
                position = position_dodge(0.9), width = 0.5),
  facet_grid(n_qtl + h2 ~ sig_level),
  ylab("False Discovery Rate"),
  xlab("Population Size"),
  ylim(c(0,1.1)),
  theme_bw())

## Plot the false discovery rate
(g_fdr_main <- power_fdr_summ %>% 
  filter(term == "main_effect") %>% 
  mutate(n_pop = as.factor(n_pop)) %>% 
  ggplot(aes(x = n_pop, y = fdr_mean, fill = model, group = model)) + 
  labs(title = "False Discovery Rate for Main Effect QTL") +
  g_mod)

(g_fdr_qxe <- power_fdr_summ %>% 
  filter(term == "qxe") %>% 
  mutate(n_pop = as.factor(n_pop)) %>% 
  ggplot(aes(x = n_pop, y = fdr_mean, fill = model, group = model)) + 
  labs(title = "False Discovery Rate for Interaction QTL") +
  g_mod)

## Save
save_file <- file.path(fig_dir, "simulation_sig_fdr_main.jpg")
ggsave(filename = save_file, plot = g_fdr_main, width = 6, height = 6)

save_file <- file.path(fig_dir, "simulation_sig_fdr_qxe.jpg")
ggsave(filename = save_file, plot = g_fdr_qxe, width = 6, height = 6)


## Reduce to the fdr = 0.05 level and the pairs (h2 = 0.8 & n_qtl = 30 and h2 = 0.5 & n_qtl = 100)
exp <- expression((sig_level == "fdr0.05") & ( (n_qtl == 30 & h2 == 0.5) | (n_qtl == 100 & h2 == 0.8) ))

g_fdr <- power_fdr_summ %>% 
  filter(eval(exp)) %>%
  mutate(n_pop = as.factor(n_pop)) %>% 
  ggplot(aes(x = n_pop, y = fdr_mean, fill = model, group = model)) + 
  labs(title = "False Discovery Rate") + 
  geom_col(position = "dodge") +
  geom_errorbar(aes(ymin = fdr_mean - fdr_sd, ymax = fdr_mean + fdr_sd), 
                position = position_dodge(0.9), width = 0.5) +
  facet_grid(n_qtl + h2 ~ term, labeller = "label_both") +
  ylab("False Discovery Rate") +
  xlab("Population Size") +
  ylim(c(0,1.1)) +
  theme_bw()

save_file <- file.path(fig_dir, "simulation_sig_fdr.jpg")
ggsave(filename = save_file, plot = g_fdr, width = 6, height = 6)

```

Power to detect QTL


```{r power}

## Plot the power
## New modifier
g_mod <- list(
  geom_col(position = "dodge"),
  geom_errorbar(aes(ymin = power_mean - power_sd, ymax = power_mean + power_sd), 
                position = position_dodge(0.9), width = 0.5),
  facet_grid(n_qtl + h2 ~ sig_level),
  ylab("Power"),
  xlab("Population Size"),
  theme_bw())

(g_power_main <- power_fdr_summ %>% 
  filter(term == "main_effect") %>% 
  mutate(n_pop = as.factor(n_pop)) %>% 
  ggplot(aes(x = n_pop, y = power_mean, fill = model, group = model)) + 
  labs(title = "Power to Detect Main Effect QTL") +
  g_mod)

(g_power_qxe <- power_fdr_summ %>% 
  filter(term == "qxe") %>% 
  mutate(n_pop = as.factor(n_pop)) %>% 
  ggplot(aes(x = n_pop, y = power_mean, fill = model, group = model)) + 
  labs(title = "Power to Detect Interaction QTL") +
  g_mod)


## Save
save_file <- file.path(fig_dir, "simulation_power_main.jpg")
ggsave(filename = save_file, plot = g_power_main, width = 6, height = 6)

save_file <- file.path(fig_dir, "simulation_power_qxe.jpg")
ggsave(filename = save_file, plot = g_power_qxe, width = 6, height = 6)


## Reduce to the fdr = 0.05 level and the pairs (h2 = 0.8 & n_qtl = 30 and h2 = 0.5 & n_qtl = 100)
exp <- expression((sig_level == "fdr0.05") & ( (n_qtl == 30 & h2 == 0.5) | (n_qtl == 100 & h2 == 0.8) ))

g_power <- power_fdr_summ %>% 
  filter(eval(exp)) %>%
  mutate(n_pop = as.factor(n_pop)) %>% 
  ggplot(aes(x = n_pop, y = power_mean, fill = model, group = model)) + 
  labs(title = "Power to Detect QTL") + 
  geom_col(position = "dodge") +
  geom_errorbar(aes(ymin = power_mean - power_sd, ymax = power_mean + power_sd), 
                position = position_dodge(0.9), width = 0.5) +
  facet_grid(n_qtl + h2 ~ term, labeller = "label_both") +
  ylab("Power") +
  xlab("Population Size") +
  ylim(c(0,1.1)) +
  theme_bw()

save_file <- file.path(fig_dir, "simulation_sig_power.jpg")
ggsave(filename = save_file, plot = g_power, width = 6, height = 6)





```

Plot the number of QTL discovered

```{r plot.disc.qtl}

# New modifier
g_mod <- list(
  geom_col(position = "dodge"),
  geom_errorbar(aes(ymin = prop_discovered_mean - prop_discovered_sd, ymax = prop_discovered_mean + prop_discovered_sd), 
                position = position_dodge(0.9), width = 0.5),
  facet_grid(n_qtl + h2 ~ sig_level),
  ylab("QTL Discovered"),
  xlab("Population Size"),
  ylim(c(-0.1,0.6)),
  theme_bw())

## Plot the number of QTL discovered
(g_disc_main <- qtl_disc_summ %>% 
  filter(term == "main_effect") %>% 
  mutate(n_pop = as.factor(n_pop)) %>% 
  ggplot(aes(x = n_pop, y = prop_discovered_mean, fill = model, group = model)) + 
  labs(title = "Proportion of Main Effect QTL Discovered") +
  g_mod)

(g_disc_qxe <- qtl_disc_summ %>% 
  filter(term == "qxe") %>% 
  mutate(n_pop = as.factor(n_pop)) %>% 
  ggplot(aes(x = n_pop, y = prop_discovered_mean, fill = model, group = model)) + 
  labs(title = "Proportion of Interaction QTL Discovered") +
  g_mod)

## Save
save_file <- file.path(fig_dir, "simulation_qtl_disc_main.jpg")
ggsave(filename = save_file, plot = g_disc_main, width = 6, height = 6)

save_file <- file.path(fig_dir, "simulation_qtl_disc_qxe.jpg")
ggsave(filename = save_file, plot = g_disc_qxe, width = 6, height = 6)


## Reduce to the fdr = 0.05 level and the pairs (h2 = 0.8 & n_qtl = 30 and h2 = 0.5 & n_qtl = 100)
exp <- expression((sig_level == "fdr0.05") & ( (n_qtl == 30 & h2 == 0.5) | (n_qtl == 100 & h2 == 0.8) ))

g_disc <- qtl_disc_summ %>% 
  filter(eval(exp)) %>%
  mutate(n_pop = as.factor(n_pop)) %>% 
  ggplot(aes(x = n_pop, y = prop_discovered_mean, fill = model, group = model)) + 
  labs(title = "QTL Discovery") + 
  geom_col(position = "dodge") +
  geom_errorbar(aes(ymin = prop_discovered_mean - prop_discovered_sd, 
                    ymax = prop_discovered_mean + prop_discovered_sd), 
                position = position_dodge(0.9), width = 0.5) +
  facet_grid(n_qtl + h2 ~ term, labeller = "label_both") +
  ylab("Proportion of QTL Discovered") +
  xlab("Population Size") +
  # ylim(c(0,1.1)) +
  theme_bw()

save_file <- file.path(fig_dir, "simulation_sig_disc.jpg")
ggsave(filename = save_file, plot = g_disc, width = 6, height = 6)




```

Plot the number of discovered QTL per false discoveries

```{r plot.disc.qtl.fdr}

# New modifier
g_mod <- list(
  geom_col(position = "dodge"),
  geom_errorbar(aes(ymin = mean - sd, ymax = mean + sd), 
                position = position_dodge(0.9), width = 0.5),
  facet_grid(n_qtl + h2 ~ sig_level),
  ylab("Number of QTL Discovered Per False Discovery"),
  xlab("Population Size"),
  theme_bw())

## Plot the number of QTL discovered per false discovery
(g_disc_fdr_main <- qtl_disc_fdr_summ %>% 
  filter(term == "main_effect") %>% 
  mutate(n_pop = as.factor(n_pop)) %>%
  rename(mean = prop_disc_per_false_mean, sd = prop_disc_per_false_sd) %>% 
  ggplot(aes(x = n_pop, y = mean, fill = model, group = model)) + 
  labs(title = "Proportion of Main Effect QTL Discovered Per False Discovery") +
  g_mod)

(g_disc_fdr_qxe <- qtl_disc_fdr_summ %>% 
  filter(term == "qxe") %>% 
  mutate(n_pop = as.factor(n_pop)) %>% 
  rename(mean = prop_disc_per_false_mean, sd = prop_disc_per_false_sd) %>% 
  ggplot(aes(x = n_pop, y = mean, fill = model, group = model)) + 
  labs(title = "Number of Interaction QTL Discovered Per False Discovery") +
  g_mod)


## Save
save_file <- file.path(fig_dir, "simulation_efficiency_main.jpg")
ggsave(filename = save_file, plot = g_disc_fdr_main, width = 6, height = 6)

save_file <- file.path(fig_dir, "simulation_efficiency_qxe.jpg")
ggsave(filename = save_file, plot = g_disc_fdr_qxe, width = 6, height = 6)



## Reduce to the fdr = 0.05 level and the pairs (h2 = 0.8 & n_qtl = 30 and h2 = 0.5 & n_qtl = 100)
exp <- expression((sig_level == "fdr0.05") & ( (n_qtl == 30 & h2 == 0.5) | (n_qtl == 100 & h2 == 0.8) ))

g_disc_fdr <- qtl_disc_fdr_summ %>% 
  filter(eval(exp)) %>%
  mutate(n_pop = as.factor(n_pop)) %>% 
  ggplot(aes(x = n_pop, y = disc_per_false_mean, fill = model, group = model)) + 
  labs(title = "Association Efficiency") + 
  geom_col(position = "dodge") +
  geom_errorbar(aes(ymin = disc_per_false_mean - disc_per_false_sd, 
                    ymax = disc_per_false_mean + disc_per_false_sd), 
                position = position_dodge(0.9), width = 0.5) +
  facet_grid(n_qtl + h2 ~ term, labeller = "label_both") +
  ylab("Number of QTL Discovered per False Discovery") +
  xlab("Population Size") +
  # ylim(c(0,1.1)) +
  theme_bw()

save_file <- file.path(fig_dir, "simulation_sig_disc_fdr.jpg")
ggsave(filename = save_file, plot = g_disc_fdr, width = 6, height = 6)




```

Construct a table of the number of significant markers, number of true QTL detectected, and the 
number of false positives






Fit a model to compare the different experimental factors

```{r model}

# False discovery rate
fd_fit <- mar_assoc_result %>% 
  filter(neg_pos == "positive", true_false == "false") %>%
  select(-true_false, -neg_pos) %>% 
  group_by(term) %>%
  do(fit = lm(n ~ ., select(., -term, -iter)))




```





